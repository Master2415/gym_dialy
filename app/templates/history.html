{% extends "base.html" %}
{% block content %}
<h2>Historial: {{ exercise_name }} üèãÔ∏è</h2>

<div
    style="background: var(--card-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border-color);">
    <canvas id="historyChart"></canvas>
</div>

<div class="table-wrapper">
    <table class="table-custom">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Series</th>
                <th>Total Reps</th>
                <th>Reps Promedio</th>
                <th>Max Peso</th>
                <th>1RM Est.</th>
                <th>Detalle (Reps x Peso)</th>
            </tr>
        </thead>
        <tbody>
            {% for h in history %}
            <tr>
                <td>{{ h[0] }}</td>
                <td>{{ h[1] }}</td>
                <td>{{ h[2] }}</td>
                <td>{{ (h[2] / h[1]) | round(1) }}</td>
                <td>{{ h[3] }} kg</td>
                <td>{{ h[5] | round(1) }} kg</td>
                <td>{{ h[4] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<p style="margin-top: 10px; font-size: 0.9em; color: var(--text-color); opacity: 0.8;">
    * <strong>Reps Promedio:</strong> Se calcula dividiendo el total de repeticiones entre el n√∫mero de series
    realizadas en esa sesi√≥n.
</p>

<br>
<a href="/workouts" class="btn">Volver a Sesiones</a>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Helper to get CSS variable value
    function getCssVar(name) {
        return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }

    const chartData = {{ chart_data | tojson }};
    const ctx = document.getElementById('historyChart').getContext('2d');
    const textColor = getCssVar('--text-color');
    const gridColor = getCssVar('--border-color');

    new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [
                {
                    label: 'Peso (kg)',
                    data: chartData['Peso'],
                    borderColor: '#36A2EB',
                    backgroundColor: '#36A2EB',
                    tension: 0.1,
                    yAxisID: 'y-weight'
                },
                {
                    label: '1RM Estimado (kg)',
                    data: chartData['1RM'],
                    borderColor: '#FF6384',
                    backgroundColor: '#FF6384',
                    tension: 0.1,
                    yAxisID: 'y-weight',
                    borderDash: [5, 5]
                },
                {
                    label: 'Repeticiones Promedio',
                    data: chartData['Reps'],
                    borderColor: '#4BC0C0',
                    backgroundColor: '#4BC0C0',
                    tension: 0.1,
                    yAxisID: 'y-reps'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: textColor }
                },
                title: {
                    display: true,
                    text: 'Evoluci√≥n de Peso y Repeticiones',
                    color: textColor
                }
            },
            scales: {
                x: {
                    type: 'category',
                    ticks: { color: textColor },
                    grid: { color: gridColor },
                    title: { display: true, text: 'Fecha', color: textColor }
                },
                'y-weight': {
                    type: 'linear',
                    position: 'left',
                    ticks: { color: textColor },
                    grid: { color: gridColor },
                    title: { display: true, text: 'Peso (kg)', color: textColor }
                },
                'y-reps': {
                    type: 'linear',
                    position: 'right',
                    ticks: { color: textColor },
                    grid: { drawOnChartArea: false },
                    title: { display: true, text: 'Repeticiones', color: textColor }
                }
            }
        }
    });
</script>
{% endblock %}