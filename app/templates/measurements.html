{% extends "base.html" %}
{% block content %}
<h2>Mediciones Corporales üìè</h2>

<div style="display: flex; flex-wrap: wrap; gap: 20px;">
    <!-- Formulario de Registro -->
    <div
        style="flex: 1; min-width: 300px; background: var(--container-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
        <h3>Registrar Nueva Medida</h3>
        <form method="POST">
            <div class="form-group">
                <label>Fecha:</label>
                <input type="date" name="fecha" required value="{{ today }}">
            </div>
            <div class="form-group">
                <label>Peso (kg):</label>
                <input type="number" step="0.1" name="peso" required>
            </div>
            <div class="form-group">
                <label>Cintura (cm):</label>
                <input type="number" step="0.1" name="cintura">
            </div>
            <div class="form-group">
                <label>Brazos (cm):</label>
                <input type="number" step="0.1" name="brazos">
            </div>
            <div class="form-group">
                <label>Piernas (cm):</label>
                <input type="number" step="0.1" name="piernas">
            </div>
            <div class="form-group">
                <label>Pecho (cm):</label>
                <input type="number" step="0.1" name="pecho">
            </div>
            <div class="form-group">
                <label>% Grasa Corporal:</label>
                <input type="number" step="0.1" name="grasa_corporal">
            </div>
            <button class="btn" type="submit">Guardar Medida</button>
        </form>
    </div>

    <!-- Calculadora de Calor√≠as -->
    <div
        style="flex: 1; min-width: 300px; background: var(--container-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
        <h3>Calculadora de Calor√≠as üçé</h3>
        <div class="form-group">
            <label>G√©nero:</label>
            <select id="calc_gender">
                <option value="male">Hombre</option>
                <option value="female">Mujer</option>
            </select>
        </div>
        <div class="form-group">
            <label>Edad:</label>
            <input type="number" id="calc_age" placeholder="A√±os">
        </div>
        <div class="form-group">
            <label>Altura (cm):</label>
            <input type="number" id="calc_height" placeholder="cm">
        </div>
        <div class="form-group">
            <label>Peso (kg):</label>
            <input type="number" id="calc_weight" placeholder="kg">
        </div>
        <div class="form-group">
            <label>Nivel de Actividad:</label>
            <select id="calc_activity">
                <option value="1.2">Sedentario (poco o nada)</option>
                <option value="1.375">Ligeramente activo (1-3 d√≠as)</option>
                <option value="1.55">Moderadamente activo (3-5 d√≠as)</option>
                <option value="1.725">Muy activo (6-7 d√≠as)</option>
                <option value="1.9">Extremadamente activo (2x d√≠a)</option>
            </select>
        </div>
        <div class="form-group">
            <label>Objetivo:</label>
            <select id="calc_goal">
                <option value="-400">Perder Peso (D√©ficit)</option>
                <option value="0">Mantenimiento</option>
                <option value="350">Ganar Masa (Super√°vit)</option>
            </select>
        </div>
        <button class="btn" type="button" onclick="calculateCalories()"
            style="background-color: #FF9800;">Calcular</button>

        <div id="calc_result"
            style="margin-top: 20px; display: none; padding: 10px; background: var(--bg-color); border-radius: 4px; border: 1px solid var(--border-color);">
            <h4>Resultados:</h4>
            <p>TMB: <strong id="res_tmb">0</strong> kcal</p>
            <p>TDEE (Mantenimiento): <strong id="res_tdee">0</strong> kcal</p>
            <p style="font-size: 1.2em; color: #4CAF50;">Calor√≠as Diarias Recomendadas: <strong
                    id="res_target">0</strong> kcal</p>
        </div>
    </div>
</div>

<br>
<h3>Evoluci√≥n de Medidas</h3>
<div style="background: var(--container-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
    <canvas id="measurementsChart"></canvas>
</div>

<br><br>
<a href="/workouts" class="btn">Volver a Sesiones</a>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // --- CALCULADORA ---
    function calculateCalories() {
        const gender = document.getElementById('calc_gender').value;
        const age = parseFloat(document.getElementById('calc_age').value);
        const height = parseFloat(document.getElementById('calc_height').value);
        const weight = parseFloat(document.getElementById('calc_weight').value);
        const activity = parseFloat(document.getElementById('calc_activity').value);
        const goal = parseFloat(document.getElementById('calc_goal').value);

        if (!age || !height || !weight) {
            alert("Por favor completa todos los campos.");
            return;
        }

        // Mifflin-St Jeor
        let tmb = (10 * weight) + (6.25 * height) - (5 * age);
        if (gender === 'male') {
            tmb += 5;
        } else {
            tmb -= 161;
        }

        const tdee = tmb * activity;
        const target = tdee + goal;

        document.getElementById('res_tmb').textContent = Math.round(tmb);
        document.getElementById('res_tdee').textContent = Math.round(tdee);
        document.getElementById('res_target').textContent = Math.round(target);
        document.getElementById('calc_result').style.display = 'block';
    }

    // --- GR√ÅFICO ---
    const chartData = {{ chart_data | tojson }};
    // chartData = { 'Peso': [{x,y},...], 'Cintura': [{x,y},...], ... }

    const ctx = document.getElementById('measurementsChart').getContext('2d');
    const datasets = [];
    const colors = ['#36A2EB', '#FF6384', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
    let colorIdx = 0;

    for (const [label, data] of Object.entries(chartData)) {
        if (data.length > 0) {
            datasets.push({
                label: label,
                data: data,
                borderColor: colors[colorIdx % colors.length],
                fill: false,
                tension: 0.1
            });
            colorIdx++;
        }
    }

    new Chart(ctx, {
        type: 'line',
        data: { datasets: datasets },
        options: {
            responsive: true,
            scales: {
                x: {
                    type: 'category',
                    title: { display: true, text: 'Fecha' }
                },
                y: {
                    title: { display: true, text: 'Valor' }
                }
            }
        }
    });
</script>
{% endblock %}