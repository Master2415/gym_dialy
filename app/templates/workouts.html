{% extends "base.html" %}
{% block content %}
<h2>Sesiones</h2>

<div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
    <a class="btn btn-primary" href="/workouts/new">Nueva sesi√≥n</a>
    <a class="btn btn-secondary" href="/exercises">Gestionar Ejercicios</a>
    <a class="btn btn-secondary" href="/analytics">Ver Progreso üìà</a>
    <a class="btn btn-secondary" href="/measurements">Mediciones üìè</a>

    <div class="dropdown">
        <button class="btn btn-secondary">Exportar üìä ‚ñº</button>
        <div class="dropdown-content">
            <a href="/export/csv">CSV</a>
            <a href="/export/json">JSON (Backup)</a>
        </div>
    </div>
</div>

<style>
    .dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        background-color: var(--container-bg);
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
        z-index: 1;
        border-radius: 4px;
        border: 1px solid var(--border-color);
    }

    .dropdown-content a {
        color: var(--text-color);
        padding: 12px 16px;
        text-decoration: none;
        display: block;
    }

    .dropdown-content a:hover {
        background-color: var(--bg-color);
    }

    .dropdown:hover .dropdown-content {
        display: block;
    }

    .exercise-link {
        color: #4CAF50;
        text-decoration: none;
        font-weight: 500;
    }

    .exercise-link:hover {
        text-decoration: underline;
    }
</style>
<br><br>
<div class="calendar-container">
    <div class="calendar-header">
        <button id="prevMonth" class="btn-small">&lt;</button>
        <h3 id="monthYear"></h3>
        <button id="nextMonth" class="btn-small">&gt;</button>
    </div>
    <div class="calendar-grid" id="calendar"></div>
</div>

<script>
    const workoutDates = {{ workout_dates | tojson }}; // List of "YYYY-MM-DD"
    const calendarEl = document.getElementById('calendar');
    const monthYearEl = document.getElementById('monthYear');
    let currentDate = new Date();

    function renderCalendar(date) {
        calendarEl.innerHTML = '';
        const year = date.getFullYear();
        const month = date.getMonth();

        monthYearEl.textContent = date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Adjust for Monday start (0=Sunday, 1=Monday...)
        // If we want Monday as first day: (firstDay + 6) % 7
        // Let's stick to standard Sunday start for simplicity or adjust if needed.
        // Let's assume standard Sunday start for now.

        for (let i = 0; i < firstDay; i++) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'calendar-day empty';
            calendarEl.appendChild(emptyDiv);
        }

        for (let i = 1; i <= daysInMonth; i++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            dayDiv.textContent = i;

            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            if (workoutDates.includes(dateString)) {
                dayDiv.classList.add('has-workout');
            }

            calendarEl.appendChild(dayDiv);
        }
    }

    document.getElementById('prevMonth').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar(currentDate);
    });

    document.getElementById('nextMonth').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar(currentDate);
    });

    renderCalendar(currentDate);
</script>
<br><br>

<div class="dashboard-stats">
    <div class="stat-card">
        <h3>{{ dashboard.days_trained }}</h3>
        <p>D√≠as Entrenados (Mes)</p>
    </div>
    <div class="stat-card">
        <h3>{{ dashboard.best_weight }} kg</h3>
        <p>Mejor Peso (R√©cord)</p>
    </div>
</div>

<!-- Filtros -->
<div class="filters">
    <form method="GET" action="/workouts" style="display: flex; gap: 10px; flex-wrap: wrap;">
        <input type="text" name="search" placeholder="Buscar ejercicio..." value="{{ filters.search }}">

        <select name="group">
            <option value="">Todos los Grupos</option>
            {% for group in muscle_groups %}
            <option value="{{ group }}" {% if filters.group==group %}selected{% endif %}>{{ group }}</option>
            {% endfor %}
        </select>

        <input type="date" name="date" value="{{ filters.date }}">

        <select name="sort">
            <option value="date_desc" {% if filters.sort=='date_desc' %}selected{% endif %}>M√°s recientes</option>
            <option value="date_asc" {% if filters.sort=='date_asc' %}selected{% endif %}>M√°s antiguos</option>
            <option value="weight_desc" {% if filters.sort=='weight_desc' %}selected{% endif %}>Mayor Peso</option>
            <option value="reps_desc" {% if filters.sort=='reps_desc' %}selected{% endif %}>M√°s Reps</option>
        </select>

        <button type="submit" class="btn btn-primary">Filtrar</button>
        <a href="/workouts" class="btn btn-secondary">Limpiar</a>
    </form>
</div>

<div class="table-wrapper">
    <table class="table-custom">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Grupo</th>
                <th>Ejercicio</th>
                <th>Series</th>
                <th>Reps Prom.</th>
                <th>Peso Prom.</th>
                <th>Comentario</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for w in workouts %}
            <tr>
                <td>{{ w[0].strftime('%Y-%m-%d') }}</td>
                <td>{{ w[1] }}</td>
                <td><a href="/history/{{ w[9] }}" class="exercise-link">{{ w[2] }}</a></td>
                <td>{{ w[3] }}</td>
                <td>{{ w[4] | round(1) }}</td>
                <td>{{ w[5] | round(1) }} kg</td>
                <td>{{ w[6] }}</td>
                <td style="white-space: nowrap;">
                    <a href="/workouts/edit/{{ w[7] }}" class="btn btn-sm btn-secondary" title="Editar">‚úèÔ∏è</a>
                    <a href="/workouts/delete/{{ w[7] }}" class="btn btn-sm btn-danger" title="Eliminar"
                        onclick="return confirm('¬øEst√°s seguro?')">üóëÔ∏è</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}