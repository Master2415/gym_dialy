{% extends "base.html" %}
{% block content %}
<h2>Sesiones</h2>

<div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
    <a class="btn btn-primary" href="/workouts/new">Nueva sesión</a>
</div>

<style>
    .dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        background-color: var(--container-bg);
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
        z-index: 1;
        border-radius: 4px;
        border: 1px solid var(--border-color);
    }

    .dropdown-content a {
        color: var(--text-color);
        padding: 12px 16px;
        text-decoration: none;
        display: block;
    }

    .dropdown-content a:hover {
        background-color: var(--bg-color);
    }

    .dropdown:hover .dropdown-content {
        display: block;
    }

    .exercise-link {
        color: #4CAF50;
        text-decoration: none;
        font-weight: 500;
    }

    .exercise-link:hover {
        text-decoration: underline;
    }
</style>
<br><br>
<div class="calendar-container">
    <div class="calendar-header">
        <button id="prevMonth" class="btn-small">&lt;</button>
        <h3 id="monthYear"></h3>
        <button id="nextMonth" class="btn-small">&gt;</button>
    </div>
    <div class="calendar-grid" id="calendar"></div>
</div>

<script>
    const workoutDates = {{ workout_dates | tojson }}; // List of "YYYY-MM-DD"
    const currentDateFilter = "{{ filters.date }}"; // Currently selected date
    const calendarEl = document.getElementById('calendar');
    const monthYearEl = document.getElementById('monthYear');

    // Initialize calendar with selected date or today
    let currentDate = currentDateFilter ? new Date(currentDateFilter + 'T00:00:00') : new Date();

    function renderCalendar(date) {
        calendarEl.innerHTML = '';
        const year = date.getFullYear();
        const month = date.getMonth();

        monthYearEl.textContent = date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'calendar-day empty';
            calendarEl.appendChild(emptyDiv);
        }

        for (let i = 1; i <= daysInMonth; i++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            dayDiv.textContent = i;

            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

            if (workoutDates.includes(dateString)) {
                dayDiv.classList.add('has-workout');
            }

            // Highlight selected date
            if (dateString === currentDateFilter) {
                dayDiv.style.border = '2px solid var(--primary-color)';
                dayDiv.style.fontWeight = 'bold';
                dayDiv.style.backgroundColor = 'rgba(var(--primary-rgb), 0.2)'; // Assuming you have this or similar
            }

            // Add click event to filter by date
            dayDiv.addEventListener('click', () => {
                const url = new URL(window.location.href);
                url.searchParams.set('date', dateString);
                window.location.href = url.toString();
            });

            calendarEl.appendChild(dayDiv);
        }
    }

    document.getElementById('prevMonth').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar(currentDate);
    });

    document.getElementById('nextMonth').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar(currentDate);
    });

    renderCalendar(currentDate);
</script>
<br><br>

<div class="dashboard-stats">
    <div class="stat-card">
        <h3>{{ dashboard.days_trained }}</h3>
        <p>Días Entrenados (Mes)</p>
    </div>
    <div class="stat-card">
        <h3>{{ dashboard.best_weight }} kg</h3>
        <p>Mejor Peso Levantado</p>
    </div>
</div>

<!-- Filtros -->
<div class="filters">
    <form method="GET" action="/workouts" style="display: flex; gap: 10px; flex-wrap: wrap;">
        <input type="text" name="search" placeholder="Buscar ejercicio..." value="{{ filters.search }}">

        <select name="group">
            <option value="">Todos los Grupos</option>
            {% for group in muscle_groups %}
            <option value="{{ group }}" {% if filters.group==group %}selected{% endif %}>{{ group }}</option>
            {% endfor %}
        </select>

        <!-- Hidden date input to maintain filter when submitting form -->
        <input type="hidden" name="date" value="{{ filters.date }}">

        <select name="sort">
            <option value="date_desc" {% if filters.sort=='date_desc' %}selected{% endif %}>Más recientes</option>
            <option value="date_asc" {% if filters.sort=='date_asc' %}selected{% endif %}>Más antiguos</option>
            <option value="weight_desc" {% if filters.sort=='weight_desc' %}selected{% endif %}>Mayor Peso</option>
            <option value="reps_desc" {% if filters.sort=='reps_desc' %}selected{% endif %}>Más Reps</option>
        </select>

        <button type="submit" class="btn btn-primary">Filtrar</button>
        <a href="/workouts" class="btn btn-secondary">Limpiar</a>
    </form>
</div>

<div class="table-wrapper">
    <table class="table-custom">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Grupo</th>
                <th>Ejercicio</th>
                <th>Series</th>
                <th>Reps Prom.</th>
                <th>Peso Prom.</th>
                <th>Comentario</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for w in workouts %}
            <tr>
                <td>{{ w[0].strftime('%Y-%m-%d') }}</td>
                <td>{{ w[1] }}</td>
                <td><a href="/history/{{ w[9] }}" class="exercise-link">{{ w[2] }}</a></td>
                <td>{{ w[3] }}</td>
                <td>{{ w[4] | round(1) }}</td>
                <td>{{ w[5] | round(1) }} kg</td>
                <td>{{ w[6] }}</td>
                <td style="white-space: nowrap;">
                    <a href="/workouts/edit/{{ w[7] }}" class="btn btn-sm btn-secondary" title="Editar">Editar</a>
                    <a href="#" class="btn btn-sm btn-danger" title="Eliminar"
                        onclick="confirmDelete('{{ w[7] }}')">Eliminar</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Navigation Buttons -->
<div style="display: flex; justify-content: space-between; margin-top: 20px;">
    {% if dashboard.prev_date %}
    <a href="{{ url_for('workouts.workouts', date=dashboard.prev_date) }}" class="btn btn-secondary">
        &larr; Día Anterior ({{ dashboard.prev_date }})
    </a>
    {% else %}
    <button class="btn btn-secondary" disabled style="opacity: 0.5; cursor: not-allowed;">&larr; Día Anterior</button>
    {% endif %}

    {% if dashboard.next_date %}
    <a href="{{ url_for('workouts.workouts', date=dashboard.next_date) }}" class="btn btn-secondary">
        Día Posterior ({{ dashboard.next_date }}) &rarr;
    </a>
    {% else %}
    <button class="btn btn-secondary" disabled style="opacity: 0.5; cursor: not-allowed;">Día Posterior &rarr;</button>
    {% endif %}
</div>

<script>
    function confirmDelete(id) {
        if (confirm('¿Estás seguro de eliminar esta sesión?')) {
            window.location.href = `/workouts/delete/${id}`;
        }
    }
</script>
{% endblock %}